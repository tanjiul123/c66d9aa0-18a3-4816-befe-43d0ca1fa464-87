import { GoogleGenerativeAI } from '@google/generative-ai';

export type ContentType = 'Facebook Post' | 'Instagram Post' | 'Twitter Post' | 'Blog Article' | 'News Article';
export type ContentTone = 'Professional' | 'Friendly' | 'Humorous' | 'Motivational' | 'Storytelling';
export type AudienceType = 'General Public' | 'Students' | 'Professionals' | 'Entrepreneurs' | 'Youth';

export interface ContentRequest {
  topic: string;
  contentType: ContentType;
  tone: ContentTone;
  audience: AudienceType;
  includeHashtags?: boolean;
  includeEmojis?: boolean;
  wordCount?: 'Short' | 'Medium' | 'Long';
}

export interface ContentResult {
  type: ContentType;
  title: string;
  content: string;
  hashtags: string[];
  keywords: string[];
  engagementTips: string[];
  estimatedReach: string;
}

const VIRAL_CONTENT_PROMPTS = {
  'Facebook Post': `
ржЖржкржирж┐ ржПржХржЬржи ржнрж╛ржЗрж░рж╛рж▓ ржХржиржЯрзЗржирзНржЯ ржХрзНрж░рж┐ржпрж╝рзЗржЯрж░ ржПржмржВ рж╕рзЛрж╢рзНржпрж╛рж▓ ржорж┐ржбрж┐ржпрж╝рж╛ ржПржХрзНрж╕ржкрж╛рж░рзНржЯред ржЖржкржирж╛рж░ ржХрж╛ржЬ рж╣рж▓ ржПржоржи ржлрзЗрж╕ржмрзБржХ ржкрзЛрж╕рзНржЯ рждрзИрж░рж┐ ржХрж░рж╛ ржпрж╛ ржорж╛ржирзБрж╖ рж╢рзЗржпрж╝рж╛рж░ ржХрж░рждрзЗ ржмрж╛ржзрзНржп рж╣ржмрзЗред

ржЯржкрж┐ржХ: "{{TOPIC}}"
ржЯрзЛржи: {{TONE}}
ржЕржбрж┐ржпрж╝рзЗржирзНрж╕: {{AUDIENCE}}

ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрж╛ржарж╛ржорзЛ ржЕржирзБрж╕рж░ржг ржХрж░рзБржи:

ЁЯОп **рж╣рзБржХ рж▓рж╛ржЗржи** (ржкрзНрж░ржержо рзз-рзи рж▓рж╛ржЗржи):
- ржЪрзЛржЦ ржзрж╛ржБржзрж╛ржирзЛ, ржХрзМрждрзВрж╣рж▓ рж╕рзГрж╖рзНржЯрж┐ржХрж╛рж░рзА
- ржкрзНрж░рж╢рзНржи ржмрж╛ ржЪржоржХржкрзНрж░ржж рждржерзНржп ржжрж┐ржпрж╝рзЗ рж╢рзБрж░рзБ
- рж╕рзНржХрзНрж░рж▓ ржерж╛ржорж╛ржирзЛрж░ ржорждрзЛ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА

ЁЯУЭ **ржорзВрж▓ ржХржиржЯрзЗржирзНржЯ**:
- ржЧрж▓рзНржкрзЗрж░ ржЫрж▓рзЗ рждржерзНржп ржЙржкрж╕рзНржерж╛ржкржирж╛
- ржмрзНржпржХрзНрждрж┐ржЧржд ржЕржнрж┐ржЬрзНржЮрждрж╛ ржмрж╛ ржЙржжрж╛рж╣рж░ржг
- ржорзВрж▓рзНржпржмрж╛ржи ржЯрж┐ржкрж╕ ржмрж╛ ржЬрзНржЮрж╛ржи
- ржЖржмрзЗржЧрзЗрж░ рж╕рж╛ржерзЗ ржпрзБржХрзНржд ржХрж░рж╛

ЁЯОм **ржХрж▓ ржЯрзБ ржЕрзНржпрж╛ржХрж╢ржи**:
- ржХржорзЗржирзНржЯ, рж╢рзЗржпрж╝рж╛рж░ ржмрж╛ рж░рж┐ржЕрзНржпрж╛ржХрзНржЯ ржХрж░рждрзЗ ржЙрзОрж╕рж╛рж╣
- ржкрзНрж░рж╢рзНржи ржХрж░рзЗ ржПржиржЧрзЗржЬржорзЗржирзНржЯ ржмрж╛ржбрж╝рж╛ржирзЛ

ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
- рззрзжрзж% ржмрж╛ржВрж▓рж╛ржпрж╝ рж▓рж┐ржЦрзБржи (ржЗржВрж░рзЗржЬрж┐ рж╢ржмрзНржж ржПржбрж╝рж┐ржпрж╝рзЗ ржЪрж▓рзБржи)
- ржЗржорзЛржЬрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи ржХрж┐ржирзНрждрзБ ржЕрждрж┐рж░рж┐ржХрзНржд ржиржпрж╝
- ржнрж╛ржЗрж░рж╛рж▓ рж╣ржУржпрж╝рж╛рж░ ржорждрзЛ рж╢рзЗржпрж╝рж╛рж░рзЗржмрж▓ ржХржиржЯрзЗржирзНржЯ рждрзИрж░рж┐ ржХрж░рзБржи
- рж╕рж╛ржВрж╕рзНржХрзГрждрж┐ржХржнрж╛ржмрзЗ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ ржПржмржВ ржЖржмрзЗржЧржоржпрж╝ рж╣рзЛржи
`,

  'Instagram Post': `
ржЖржкржирж┐ ржПржХржЬржи ржЗржирж╕рзНржЯрж╛ржЧрзНрж░рж╛ржо ржХржиржЯрзЗржирзНржЯ рж╕рзНржкрзЗрж╢рж╛рж▓рж┐рж╕рзНржЯ ржпрж┐ржирж┐ ржнрж╛ржЗрж░рж╛рж▓ ржХрзНржпрж╛ржкрж╢ржи рждрзИрж░рж┐ ржХрж░рзЗржиред

ржЯржкрж┐ржХ: "{{TOPIC}}"
ржЯрзЛржи: {{TONE}}
ржЕржбрж┐ржпрж╝рзЗржирзНрж╕: {{AUDIENCE}}

ржЗржирж╕рзНржЯрж╛ржЧрзНрж░рж╛ржо ржХрзНржпрж╛ржкрж╢ржи ржХрж╛ржарж╛ржорзЛ:

ЁЯМЯ **ржЖржЗ-ржХрзНржпрж╛ржЪрж┐ржВ ржУржкрзЗржирж╛рж░**:
- ржкрзНрж░ржержо рж▓рж╛ржЗржирзЗржЗ ржоржирзЛржпрзЛржЧ ржЖржХрж░рзНрж╖ржг
- ржЗржорзЛржЬрж┐ ржжрж┐ржпрж╝рзЗ ржнрж┐ржЬрзБржпрж╝рж╛рж▓ ржЖржмрзЗржжржи

ЁЯУ╕ **рж╕рзНржЯрзЛрж░рж┐ ржЯрзЗрж▓рж┐ржВ**:
- ржЫрзЛржЯ, ржЖржХрж░рзНрж╖ржгрзАржпрж╝ ржЧрж▓рзНржк
- ржмрзНржпржХрзНрждрж┐ржЧржд ржЕржнрж┐ржЬрзНржЮрждрж╛ рж╢рзЗржпрж╝рж╛рж░
- рж░рж┐рж▓рзЗржЯрзЗржмрж▓ ржорзБрж╣рзВрж░рзНржд

ЁЯТб **ржнрзНржпрж╛рж▓рзБ ржкрзНрж░рзЛржнрж╛ржЗржб**:
- ржХрж╛рж░рзНржпржХрж░ ржЯрж┐ржкрж╕
- ржЕржирзБржкрзНрж░рзЗрж░ржгрж╛ржорзВрж▓ржХ ржмрж╛рж░рзНрждрж╛
- рж╢рж┐ржХрзНрж╖ржгрзАржпрж╝ рждржерзНржп

ЁЯФе **ржПржиржЧрзЗржЬржорзЗржирзНржЯ ржмрзБрж╕рзНржЯрж╛рж░**:
- ржкрзНрж░рж╢рзНржи ржХрж░рзБржи
- ржорждрж╛ржоржд ржЪрж╛ржи
- рж╢рзЗржпрж╝рж╛рж░ ржХрж░рждрзЗ ржЙрзОрж╕рж╛рж╣ ржжрж┐ржи

ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
- ржЗржирж╕рзНржЯрж╛ржЧрзНрж░рж╛ржорзЗрж░ ржЬржирзНржп ржЕржкрзНржЯрж┐ржорж╛ржЗржЬржб
- ржнрж┐ржЬрзБржпрж╝рж╛рж▓ ржХржиржЯрзЗржирзНржЯрзЗрж░ рж╕рж╛ржерзЗ ржорж╛ржирж╛ржирж╕ржЗ
- рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ-ржлрзНрж░рзЗржирзНржбрж▓рж┐
- ржЗржорзЛржЬрж┐ рж╕рзНржЯрзНрж░рзНржпрж╛ржЯрзЗржЬрж┐ржХрзНржпрж╛рж▓рж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
`,

  'Twitter Post': `
ржЖржкржирж┐ ржПржХржЬржи ржЯрзБржЗржЯрж╛рж░/ржПржХрзНрж╕ ржХржиржЯрзЗржирзНржЯ ржПржХрзНрж╕ржкрж╛рж░рзНржЯ ржпрж┐ржирж┐ ржнрж╛ржЗрж░рж╛рж▓ ржерзНрж░рзЗржб ржПржмржВ ржЯрзБржЗржЯ рждрзИрж░рж┐ ржХрж░рзЗржиред

ржЯржкрж┐ржХ: "{{TOPIC}}"
ржЯрзЛржи: {{TONE}}
ржЕржбрж┐ржпрж╝рзЗржирзНрж╕: {{AUDIENCE}}

ржЯрзБржЗржЯрж╛рж░ ржХржиржЯрзЗржирзНржЯ ржлрж░ржорзНржпрж╛ржЯ:

ЁЯз╡ **ржерзНрж░рзЗржб рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░** (ржпржжрж┐ ржжрзАрж░рзНржШ ржХржиржЯрзЗржирзНржЯ рж╣ржпрж╝):
1/ рж╣рзБржХ ржЯрзБржЗржЯ - рж╕ржмржЪрзЗржпрж╝рзЗ ржЖржХрж░рзНрж╖ржгрзАржпрж╝
2/ рж╕ржорж╕рзНржпрж╛/ржкрзНрж░рж╢рзНржи ржЙржкрж╕рзНржерж╛ржкржирж╛
3-5/ рж╕ржорж╛ржзрж╛ржи/рждржерзНржп/ржЧрж▓рзНржк
рж╢рзЗрж╖/ рж╕рж╛рж░рж╛ржВрж╢ + CTA

тЪб **рж╕рж┐ржЩрзНржЧрзЗрж▓ ржЯрзБржЗржЯ** (ржпржжрж┐ ржЫрзЛржЯ ржХржиржЯрзЗржирзНржЯ рж╣ржпрж╝):
- рзирзорзж ржХрзНржпрж╛рж░рзЗржХрзНржЯрж╛рж░рзЗрж░ ржоржзрзНржпрзЗ
- ржкрж╛ржЮрзНржЪрж┐ ржПржмржВ ржорзЗржорзЛрж░рзЗржмрж▓
- рж░рж┐ржЯрзБржЗржЯ ржХрж░рж╛рж░ ржорждрзЛ

ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
- ржжрзНрж░рзБржд ржкржбрж╝рж╛ ржпрж╛ржпрж╝ ржПржоржи
- рж╢рзЗржпрж╝рж╛рж░ ржХрж░рж╛рж░ ржорждрзЛ ржорзВрж▓рзНржпржмрж╛ржи
- ржЯрзНрж░рзЗржирзНржбрж┐ржВ ржЯржкрж┐ржХрзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд
- ржмрж╛ржВрж▓рж╛ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
`,

  'Blog Article': `
ржЖржкржирж┐ ржПржХржЬржи ржкрзНрж░ржлрзЗрж╢ржирж╛рж▓ ржмрж╛ржВрж▓рж╛ ржмрзНрж▓ржЧ рж░рж╛ржЗржЯрж╛рж░ ржПржмржВ ржХржиржЯрзЗржирзНржЯ рж╕рзНржЯрзНрж░рзНржпрж╛ржЯрзЗржЬрж┐рж╕рзНржЯред

ржЯржкрж┐ржХ: "{{TOPIC}}"
ржЯрзЛржи: {{TONE}}
ржЕржбрж┐ржпрж╝рзЗржирзНрж╕: {{AUDIENCE}}

ржмрзНрж▓ржЧ ржЖрж░рзНржЯрж┐ржХрзЗрж▓ ржХрж╛ржарж╛ржорзЛ:

ЁЯУЭ **ржЖржХрж░рзНрж╖ржгрзАржпрж╝ рж╢рж┐рж░рзЛржирж╛ржо**:
- SEO ржЕржкрзНржЯрж┐ржорж╛ржЗржЬржб
- ржХрзНрж▓рж┐ржХ ржХрж░рждрзЗ ржмрж╛ржзрзНржп ржХрж░рзЗ
- ржХрзМрждрзВрж╣рж▓ рж╕рзГрж╖рзНржЯрж┐ ржХрж░рзЗ

ЁЯОп **ржнрзВржорж┐ржХрж╛** (рззрзлрзж-рзирзжрзж рж╢ржмрзНржж):
- рж╕ржорж╕рзНржпрж╛ ржЪрж┐рж╣рзНржирж┐рждржХрж░ржг
- ржкрж╛ржаржХрзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзЛржЧ
- ржЖрж░рзНржЯрж┐ржХрзЗрж▓рзЗрж░ рж░рзЛржбржорзНржпрж╛ржк

ЁЯУЪ **ржорзВрж▓ ржЕржВрж╢** (рзо-рззрзжржЯрж┐ рж╕рзЗржХрж╢ржи):
- ржкрзНрж░рждрж┐ржЯрж┐ рж╕рзЗржХрж╢ржирзЗ H2/H3 рж╣рзЗржбрж┐ржВ
- ржмрж╛рж╕рзНрждржм ржЙржжрж╛рж╣рж░ржг ржПржмржВ ржХрзЗрж╕ рж╕рзНржЯрж╛ржбрж┐
- ржЕрзНржпрж╛ржХрж╢ржирзЗржмрж▓ ржЯрж┐ржкрж╕
- ржбрзЗржЯрж╛ ржПржмржВ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи

ЁЯОм **ржЙржкрж╕ржВрж╣рж╛рж░**:
- ржорзВрж▓ ржкржпрж╝рзЗржирзНржЯржЧрзБрж▓рж┐рж░ рж╕рж╛рж░рж╛ржВрж╢
- ржкрж░ржмрж░рзНрждрзА ржкржжржХрзНрж╖рзЗржкрзЗрж░ ржирж┐рж░рзНржжрзЗрж╢ржирж╛
- ржХрж▓ ржЯрзБ ржЕрзНржпрж╛ржХрж╢ржи

ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
- рззрзлрзжрзж-рзирзлрзжрзж рж╢ржмрзНржжрзЗрж░ ржоржзрзНржпрзЗ
- SEO ржХрзАржУржпрж╝рж╛рж░рзНржб ржкрзНрж░рж╛ржХрзГрждрж┐ржХржнрж╛ржмрзЗ ржмрзНржпржмрж╣рж╛рж░
- ржкржбрж╝рждрзЗ рж╕рж╣ржЬ ржПржмржВ рж╕рзНржХрзНржпрж╛ржирзЗржмрж▓
- ржЧржмрзЗрж╖ржгрж╛ржнрж┐рждрзНрждрж┐ржХ ржПржмржВ рждржерзНржпржмрж╣рзБрж▓
`,

  'News Article': `
ржЖржкржирж┐ ржПржХржЬржи ржЕржнрж┐ржЬрзНржЮ рж╕ржВржмрж╛ржж рж╕ржорзНржкрж╛ржжржХ ржПржмржВ ржЬрж╛рж░рзНржирж╛рж▓рж┐рж╕рзНржЯред

ржЯржкрж┐ржХ: "{{TOPIC}}"
ржЯрзЛржи: {{TONE}}
ржЕржбрж┐ржпрж╝рзЗржирзНрж╕: {{AUDIENCE}}

рж╕ржВржмрж╛ржж ржЖрж░рзНржЯрж┐ржХрзЗрж▓ ржХрж╛ржарж╛ржорзЛ:

ЁЯУ░ **рж╣рзЗржбрж▓рж╛ржЗржи**:
- рждрж╛рзОржХрзНрж╖ржгрж┐ржХ ржПржмржВ ржЖржХрж░рзНрж╖ржгрзАржпрж╝
- ржорзВрж▓ рждржерзНржп ржкрзНрж░ржХрж╛рж╢ ржХрж░рзЗ
- ржХрзНрж▓рж┐ржХржмрзЗржЗржЯ ржиржпрж╝, рждржерзНржпржмрж╣рзБрж▓

ЁЯФе **рж▓рж┐ржб ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржл**:
- рзлWрззH (ржХрзА, ржХрзЗ, ржХржЦржи, ржХрзЛржерж╛ржпрж╝, ржХрзЗржи, ржХрзАржнрж╛ржмрзЗ)
- рж╕ржмржЪрзЗржпрж╝рзЗ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рждржерзНржп ржкрзНрж░ржержорзЗ
- рзлрзж-рзнрзл рж╢ржмрзНржжрзЗрж░ ржоржзрзНржпрзЗ

ЁЯУК **ржмржбрж┐ ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржл**:
- рждржерзНржпрзЗрж░ ржЧрзБрж░рзБрждрзНржм ржЕржирзБржпрж╛ржпрж╝рзА рж╕рж╛ржЬрж╛ржирзЛ
- ржЙржжрзНржзрзГрждрж┐ ржПржмржВ ржмрж┐ржмрзГрждрж┐
- ржкрзНрж░рж╕ржЩрзНржЧ ржПржмржВ ржкржЯржнрзВржорж┐

ЁЯОп **рж╕ржорж╛ржкржирзА**:
- ржнржмрж┐рж╖рзНржпрзО ржкрзНрж░ржнрж╛ржм
- ржкрж░ржмрж░рзНрждрзА ржкржжржХрзНрж╖рзЗржк
- ржпрзЛржЧрж╛ржпрзЛржЧрзЗрж░ рждржерзНржп (ржпржжрж┐ ржкрзНрж░ржпрж╝рзЛржЬржи рж╣ржпрж╝)

ржмрж┐рж╢рзЗрж╖ ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
- ржирж┐рж░ржкрзЗржХрзНрж╖ ржПржмржВ рждржерзНржпржнрж┐рждрзНрждрж┐ржХ
- ржжрзНрж░рзБржд ржкржбрж╝рж╛ ржпрж╛ржпрж╝
- ржмрж┐рж╢рзНржмрж╛рж╕ржпрзЛржЧрзНржп рж╕рзВрждрзНрж░ ржЙрж▓рзНрж▓рзЗржЦ
- рж╕ржоржпрж╝рзЛржкржпрзЛржЧрзА ржПржмржВ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ
`
};

const HASHTAG_PROMPTS = {
  'Facebook Post': 'ржмрж╛ржВрж▓рж╛ ржПржмржВ ржЗржВрж░рзЗржЬрж┐ ржорж┐рж╢рзНрж░рж┐ржд рзо-рззрзжржЯрж┐ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ рждрзИрж░рж┐ ржХрж░рзБржи ржпрж╛ ржлрзЗрж╕ржмрзБржХрзЗ ржнрж╛ржЗрж░рж╛рж▓ рж╣рждрзЗ ржкрж╛рж░рзЗ',
  'Instagram Post': 'ржЗржирж╕рзНржЯрж╛ржЧрзНрж░рж╛ржорзЗрж░ ржЬржирзНржп рззрзл-рзирзжржЯрж┐ ржЯрзНрж░рзЗржирзНржбрж┐ржВ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ (ржмрж╛ржВрж▓рж╛ + ржЗржВрж░рзЗржЬрж┐) рждрзИрж░рж┐ ржХрж░рзБржи',
  'Twitter Post': 'ржЯрзБржЗржЯрж╛рж░рзЗрж░ ржЬржирзНржп рзл-рзоржЯрж┐ ржХрж╛рж░рзНржпржХрж░ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ рждрзИрж░рж┐ ржХрж░рзБржи',
  'Blog Article': 'SEO ржЕржкрзНржЯрж┐ржорж╛ржЗржЬржб рззрзж-рззрзлржЯрж┐ ржХрзАржУржпрж╝рж╛рж░рзНржб ржПржмржВ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ рждрзИрж░рж┐ ржХрж░рзБржи',
  'News Article': 'рж╕ржВржмрж╛ржжрзЗрж░ ржЬржирзНржп ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ рзл-рзоржЯрж┐ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧ рждрзИрж░рж┐ ржХрж░рзБржи'
};

export class GeminiService {
  private genAI: GoogleGenerativeAI | null = null;
  private apiKey: string = '';

  constructor(apiKey?: string) {
    if (apiKey) {
      this.setApiKey(apiKey);
    }
  }

  setApiKey(apiKey: string) {
    this.apiKey = apiKey;
    this.genAI = new GoogleGenerativeAI(apiKey);
  }

  async generateContent(request: ContentRequest): Promise<ContentResult> {
    if (!this.genAI) {
      throw new Error('Gemini API key not set. Please provide your API key.');
    }

    const model = this.genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    
    // Generate main content
    const contentPrompt = this.buildContentPrompt(request);
    
    try {
      const contentResult = await model.generateContent(contentPrompt);
      const contentResponse = await contentResult.response;
      const contentText = contentResponse.text();

      // Generate hashtags separately
      const hashtagPrompt = this.buildHashtagPrompt(request);
      const hashtagResult = await model.generateContent(hashtagPrompt);
      const hashtagResponse = await hashtagResult.response;
      const hashtagText = hashtagResponse.text();

      return this.parseResponse(contentText, hashtagText, request);
    } catch (error) {
      console.error('Error generating content:', error);
      throw new Error('ржХржиржЯрзЗржирзНржЯ рждрзИрж░рж┐ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред');
    }
  }

  private buildContentPrompt(request: ContentRequest): string {
    const basePrompt = VIRAL_CONTENT_PROMPTS[request.contentType];
    
    return basePrompt
      .replace('{{TOPIC}}', request.topic)
      .replace('{{TONE}}', request.tone)
      .replace('{{AUDIENCE}}', request.audience) + `

ржирж┐ржорзНржирзЛржХрзНржд ржлрж░ржорзНржпрж╛ржЯрзЗ ржЖржЙржЯржкрзБржЯ ржжрж┐ржи:

CONTENT_TITLE_START
[ржПржЦрж╛ржирзЗ ржХржиржЯрзЗржирзНржЯрзЗрж░ рж╢рж┐рж░рзЛржирж╛ржо рж▓рж┐ржЦрзБржи]
CONTENT_TITLE_END

CONTENT_BODY_START
[ржПржЦрж╛ржирзЗ ржорзВрж▓ ржХржиржЯрзЗржирзНржЯ рж▓рж┐ржЦрзБржи]
CONTENT_BODY_END

ENGAGEMENT_TIPS_START
[ржПржЦрж╛ржирзЗ рзлржЯрж┐ ржПржиржЧрзЗржЬржорзЗржирзНржЯ ржмрж╛ржбрж╝рж╛ржирзЛрж░ ржЯрж┐ржкрж╕ ржжрж┐ржи]
ENGAGEMENT_TIPS_END

ESTIMATED_REACH_START
[ржПржЗ ржХржиржЯрзЗржирзНржЯрзЗрж░ рж╕ржорзНржнрж╛ржмрзНржп рж░рж┐ржЪ ржПржмржВ ржПржиржЧрзЗржЬржорзЗржирзНржЯ ржкрзНрж░рзЗржбрж┐ржХрж╢ржи]
ESTIMATED_REACH_END`;
  }

  private buildHashtagPrompt(request: ContentRequest): string {
    return `${HASHTAG_PROMPTS[request.contentType]} ржЯржкрж┐ржХ: "${request.topic}" ржПрж░ ржЬржирзНржпред

ржирж┐ржорзНржирзЛржХрзНржд ржлрж░ржорзНржпрж╛ржЯрзЗ ржЖржЙржЯржкрзБржЯ ржжрж┐ржи:

HASHTAGS_START
[ржПржЦрж╛ржирзЗ рж╣рзНржпрж╛рж╢ржЯрзНржпрж╛ржЧржЧрзБрж▓рзЛ рж▓рж┐ржЦрзБржи, ржкрзНрж░рждрж┐ржЯрж┐ ржирждрзБржи рж▓рж╛ржЗржирзЗ]
HASHTAGS_END

KEYWORDS_START
[ржПржЦрж╛ржирзЗ SEO ржХрзАржУржпрж╝рж╛рж░рзНржбржЧрзБрж▓рзЛ рж▓рж┐ржЦрзБржи, ржкрзНрж░рждрж┐ржЯрж┐ ржирждрзБржи рж▓рж╛ржЗржирзЗ]
KEYWORDS_END`;
  }

  private parseResponse(contentText: string, hashtagText: string, request: ContentRequest): ContentResult {
    try {
      // Extract title
      const titleMatch = contentText.match(/CONTENT_TITLE_START\s*([\s\S]*?)\s*CONTENT_TITLE_END/);
      const title = titleMatch ? titleMatch[1].trim() : `${request.contentType} рж╢рж┐рж░рзЛржирж╛ржо`;

      // Extract content
      const contentMatch = contentText.match(/CONTENT_BODY_START\s*([\s\S]*?)\s*CONTENT_BODY_END/);
      const content = contentMatch ? contentMatch[1].trim() : 'ржХржиржЯрзЗржирзНржЯ рждрзИрж░рж┐ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ';

      // Extract engagement tips
      const tipsMatch = contentText.match(/ENGAGEMENT_TIPS_START\s*([\s\S]*?)\s*ENGAGEMENT_TIPS_END/);
      const tipsText = tipsMatch ? tipsMatch[1].trim() : '';
      const engagementTips = tipsText.split('\n').map(tip => tip.trim().replace(/^[-тАв]\s*/, '')).filter(tip => tip.length > 0);

      // Extract estimated reach
      const reachMatch = contentText.match(/ESTIMATED_REACH_START\s*([\s\S]*?)\s*ESTIMATED_REACH_END/);
      const estimatedReach = reachMatch ? reachMatch[1].trim() : 'ржорж╛ржЭрж╛рж░рж┐ ржерзЗржХрзЗ ржЙржЪрзНржЪ рж░рж┐ржЪ ржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд';

      // Extract hashtags
      const hashtagMatch = hashtagText.match(/HASHTAGS_START\s*([\s\S]*?)\s*HASHTAGS_END/);
      const hashtagsText = hashtagMatch ? hashtagMatch[1].trim() : '';
      const hashtags = hashtagsText.split('\n').map(tag => tag.trim().replace(/^#/, '')).filter(tag => tag.length > 0);

      // Extract keywords
      const keywordMatch = hashtagText.match(/KEYWORDS_START\s*([\s\S]*?)\s*KEYWORDS_END/);
      const keywordsText = keywordMatch ? keywordMatch[1].trim() : '';
      const keywords = keywordsText.split('\n').map(keyword => keyword.trim()).filter(keyword => keyword.length > 0);

      return {
        type: request.contentType,
        title,
        content,
        hashtags: hashtags.length > 0 ? hashtags : ['ржмрж╛ржВрж▓рж╛', 'ржХржиржЯрзЗржирзНржЯ', 'ржнрж╛ржЗрж░рж╛рж▓'],
        keywords: keywords.length > 0 ? keywords : ['ржмрж╛ржВрж▓рж╛ ржХржиржЯрзЗржирзНржЯ', 'рж╕рзЛрж╢рзНржпрж╛рж▓ ржорж┐ржбрж┐ржпрж╝рж╛'],
        engagementTips: engagementTips.length > 0 ? engagementTips : ['ржирж┐ржпрж╝ржорж┐ржд ржкрзЛрж╕рзНржЯ ржХрж░рзБржи', 'ржЕржбрж┐ржпрж╝рзЗржирзНрж╕рзЗрж░ рж╕рж╛ржерзЗ ржЗржирзНржЯрж╛рж░ржЕрзНржпрж╛ржХрзНржЯ ржХрж░рзБржи'],
        estimatedReach
      };
    } catch (error) {
      console.error('Error parsing response:', error);
      throw new Error('рж░рзЗрж╕ржкржирзНрж╕ ржкрж╛рж░рзНрж╕ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ');
    }
  }

  async getTrendingTopics(): Promise<string[]> {
    if (!this.genAI) {
      return [
        'ржбрж┐ржЬрж┐ржЯрж╛рж▓ ржорж╛рж░рзНржХрзЗржЯрж┐ржВ',
        'ржЕржирж▓рж╛ржЗржи ржЖржпрж╝',
        'рж╕рзНржмрж╛рж╕рзНржерзНржп ржЯрж┐ржкрж╕',
        'ржкрзНрж░ржпрзБржХрзНрждрж┐ ржирж┐ржЙржЬ',
        'ржмрзНржпржмрж╕рж╛ржпрж╝рж┐ржХ ржХрзМрж╢рж▓'
      ];
    }

    const model = this.genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    const prompt = `ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗ ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржЯрзНрж░рзЗржирзНржбрж┐ржВ рззрзжржЯрж┐ ржЯржкрж┐ржХ ржжрж┐ржи ржпрж╛ рж╕рзЛрж╢рзНржпрж╛рж▓ ржорж┐ржбрж┐ржпрж╝рж╛ржпрж╝ ржнрж╛ржЗрж░рж╛рж▓ рж╣рждрзЗ ржкрж╛рж░рзЗред рж╢рзБржзрзБржорж╛рждрзНрж░ ржЯржкрж┐ржХрзЗрж░ ржирж╛ржо ржжрж┐ржи, ржкрзНрж░рждрж┐ржЯрж┐ ржирждрзБржи рж▓рж╛ржЗржирзЗред`;

    try {
      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();
      
      return text.split('\n')
        .map(topic => topic.trim().replace(/^\d+\.\s*/, ''))
        .filter(topic => topic.length > 0)
        .slice(0, 10);
    } catch (error) {
      console.error('Error getting trending topics:', error);
      return [
        'ржбрж┐ржЬрж┐ржЯрж╛рж▓ ржорж╛рж░рзНржХрзЗржЯрж┐ржВ',
        'ржЕржирж▓рж╛ржЗржи ржЖржпрж╝',
        'рж╕рзНржмрж╛рж╕рзНржерзНржп ржЯрж┐ржкрж╕',
        'ржкрзНрж░ржпрзБржХрзНрждрж┐ ржирж┐ржЙржЬ',
        'ржмрзНржпржмрж╕рж╛ржпрж╝рж┐ржХ ржХрзМрж╢рж▓'
      ];
    }
  }
}